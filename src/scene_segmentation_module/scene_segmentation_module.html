
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>7.5. Scene Segmentation Module Process &#8212; Viper Vision Inference Processing Endogenous (Edge) Robot</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet">
  <link href="../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script kind="utterances">

    var commentsRunWhenDOMLoaded = cb => {
    if (document.readyState != 'loading') {
        cb()
    } else if (document.addEventListener) {
        document.addEventListener('DOMContentLoaded', cb)
    } else {
        document.attachEvent('onreadystatechange', function() {
        if (document.readyState == 'complete') cb()
        })
    }
}

var addUtterances = () => {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src = "https://utteranc.es/client.js";
    script.async = "async";

    script.setAttribute("repo", "https://github.com/AndrewDamico/viper");
    script.setAttribute("issue-term", "pathname");
    script.setAttribute("theme", "github-light");
    script.setAttribute("label", "üí¨ comment");
    script.setAttribute("crossorigin", "anonymous");

    sections = document.querySelectorAll("div.section");
    if (sections !== null) {
        section = sections[sections.length-1];
        section.appendChild(script);
    }
}
commentsRunWhenDOMLoaded(addUtterances);
</script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="7.6. Scene Segmentation Model" href="scene_segmentation_model.html" />
    <link rel="prev" title="7. Scene Segmentation Module" href="readme.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Viper Vision Inference Processing Endogenous (Edge) Robot</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../intro.html">
   Vision Inference Processing Endogenous Robot
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Introduction
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../readme.html">
   1. The ROS VIPER Library
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../docs/communication_diagram.html">
   2. Viper Communication Diagram
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../docs/process_diagram.html">
   3. Viper Data Process Diagram
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../docs/ros_structure.html">
   4. Robot OS (ROS)
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../viper_toolkit/sample_publisher.html">
     4.2. Sample Publisher Nodes
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../viper_toolkit/sample_subscriber.html">
     4.3. Sample Subscriber Nodes
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Packages
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../model_server/readme.html">
   5. Model Server
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../model_server/model_server.html">
     5.1. Model Server
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../model_server/neural_network_loader.html">
     5.2. Neural Network Loader
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../image_server/readme.html">
   6. Image Server
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../image_server/image_server.html">
     6.1. Image Server
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="readme.html">
   7. Scene Segmentation Module
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     7.5. Scene Segmentation Module Process
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="scene_segmentation_model.html">
     7.6. Scene Segmentation Model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="example.html">
     7.7. Scene Segmentation Example
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../pose_detection_module/readme.html">
   8. Pose Detection Module
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../pose_detection_module/pose_detection_module.html">
     8.1. Pose Detection Module
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../pose_detection_module/pose_detection_model.html">
     8.2. Pose Detection Model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../pose_detection_module/example.html">
     8.3. Pose Detection Example
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../augmented_vr_module/readme.html">
   9. Augmented VR Module
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../augmented_vr_module/augmented_vr_module.html">
     9.1. Augmented VR Module
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../viper_toolkit/readme.html">
   10. Viper Toolkit
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../viper_toolkit/viper_toolkit_python_modules.html">
     10.1. NameManager
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../viper_toolkit/logger.html">
     10.5. Logger Module
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../viper_toolkit/name_manager.html">
     10.6. Name Manager
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../viper_toolkit/parameter_manager.html">
     10.7. Parameter Manager
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../viper_toolkit/process_timer.html">
     10.8. Process Timer
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Hardware
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../docs/Hardware.html">
   Hardware Configuration
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://www.raspberrypi.com/">
   Raspberry Pi
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Software
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference external" href="https://www.linux.com">
   Linux Website
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/src/scene_segmentation_module/scene_segmentation_module.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/AndrewDamico/viper"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/AndrewDamico/viper/issues/new?title=Issue%20on%20page%20%2Fsrc/scene_segmentation_module/scene_segmentation_module.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/AndrewDamico/viper/edit/main/https://andrewdamico.github.io/viper/src/scene_segmentation_module/scene_segmentation_module.ipynb"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/AndrewDamico/viper/main?urlpath=tree/https://andrewdamico.github.io/viper/src/scene_segmentation_module/scene_segmentation_module.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#class-definition">
   7.5.1. Class Definition
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#initializing-the-scenesegmentationmodule-class">
     7.5.1.1. Initializing the SceneSegmentationModule Class
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#setup-paramters">
     7.5.1.2. Setup Paramters
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#setting-up-ros-and-the-model-server">
       7.5.1.2.1. Setting up ROS and the Model Server
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#imageserverclient">
     7.5.1.3. ImageServerClient
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#action-loop">
     7.5.1.4. Action Loop
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-main-loop">
     7.5.1.5. The Main Loop
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="scene-segmentation-module-process">
<h1><span class="section-number">7.5. </span>Scene Segmentation Module Process<a class="headerlink" href="#scene-segmentation-module-process" title="Permalink to this headline">¬∂</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">viper_toolkit</span> <span class="k">import</span> <span class="n">Dissect</span>
<span class="kn">from</span> <span class="nn">scripts.scene_segmentation_module</span> <span class="k">import</span> <span class="n">SceneSegmentationModule</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">ipykernel_20740</span><span class="o">/</span><span class="mf">1769777889.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="kn">import</span> <span class="nn">inspect</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="kn">from</span> <span class="nn">viper_toolkit</span> <span class="kn">import</span> <span class="n">Dissect</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="kn">from</span> <span class="nn">scripts.scene_segmentation_module</span> <span class="kn">import</span> <span class="n">SceneSegmentationModule</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;scripts.scene_segmentation_module&#39;
</pre></div>
</div>
</div>
</div>
<p>The Scene Segmentation Module is a ROS Package Module which is comprised of:</p>
<ul class="simple">
<li><p>the SceneSegmentationModule Class Object</p></li>
<li><p>the SceneSegmentationModel processing library</p></li>
<li><p>the RoadSegmentation ADAS Model and pretrained weights.</p></li>
</ul>
<div class="section" id="class-definition">
<h2><span class="section-number">7.5.1. </span>Class Definition<a class="headerlink" href="#class-definition" title="Permalink to this headline">¬∂</a></h2>
<div class="section" id="initializing-the-scenesegmentationmodule-class">
<h3><span class="section-number">7.5.1.1. </span>Initializing the SceneSegmentationModule Class<a class="headerlink" href="#initializing-the-scenesegmentationmodule-class" title="Permalink to this headline">¬∂</a></h3>
<p>The class loads a NameManager, the InferenceResults() message type, and the setup functions upon initalization</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Dissect</span><span class="p">(</span><span class="s2">&quot;__init__&quot;</span><span class="p">,</span> <span class="n">SceneSegmentationModule</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>class SceneSegmentationModule(object):

    def __init__(self):
        self.name = NameManager(abv=&quot;SEG&quot;)
        self.inference = InferenceResults()
        self.setup_ros()
        #self.setup_model()
        self.loop()
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="setup-paramters">
<h3><span class="section-number">7.5.1.2. </span>Setup Paramters<a class="headerlink" href="#setup-paramters" title="Permalink to this headline">¬∂</a></h3>
<p>We initalize several parameters with the parameter server, including the rate at which we would like the node to run, as well as if we would like to be able to dynamically update this node. This will allow us to change its rate once it is already running to optimize its performance with the other nodes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Dissect</span><span class="p">(</span><span class="s2">&quot;setup_parameters&quot;</span><span class="p">,</span> <span class="n">SceneSegmentationModule</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>class SceneSegmentationModule(object):

    def setup_parameters(self):
        self.parameters = ParameterManager()
        self.parameters.add(Parameter(
            name=&quot;rate&quot;, 
            target=f&quot;{self.name.name}/rate&quot;, 
            default=50, 
            dynamic=True
            ))
        self.parameters.add(Parameter(
            name=&quot;updates&quot;, 
            target=f&quot;{self.name.name}/dynamic&quot;, 
            default=True, 
            dynamic=True
            ))
</pre></div>
</div>
</div>
</div>
<div class="section" id="setting-up-ros-and-the-model-server">
<h4><span class="section-number">7.5.1.2.1. </span>Setting up ROS and the Model Server<a class="headerlink" href="#setting-up-ros-and-the-model-server" title="Permalink to this headline">¬∂</a></h4>
<p>We setup the module and register it with the ROS network. We also setup the <strong>model_server/modeling_service</strong> ServiceProxy which we will use to request new Models. The request message ‚ÄòModelRequest‚Äô takes the name of a model (SEG is the name of the Segmentation model) and returns an Inference.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Dissect</span><span class="p">(</span><span class="s2">&quot;setup_ros&quot;</span><span class="p">,</span> <span class="n">SceneSegmentationModule</span><span class="p">)</span>
<span class="n">Dissect</span><span class="p">(</span><span class="s2">&quot;setup_model_server&quot;</span><span class="p">,</span> <span class="n">SceneSegmentationModule</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>class SceneSegmentationModule(object):

    def setup_ros(self):
        self.setup_parameters()
        rospy.init_node(&#39;scene_segmentation&#39;, log_level=rospy.DEBUG)
        self.setup_model_server()
        self.image_server = ImageServerClient(self.name.abv)

class SceneSegmentationModule(object):

    def setup_model_server(self):
        
        self.model_request = rospy.ServiceProxy(
            &#39;model_server/modeling_service&#39;,
            ModelRequest,
            )

        self.pub = rospy.Publisher(
            &#39;model_output/scene_segmentation/segmentation_mask&#39;,
            InferenceResults,
            queue_size=1
            )
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="imageserverclient">
<h3><span class="section-number">7.5.1.3. </span>ImageServerClient<a class="headerlink" href="#imageserverclient" title="Permalink to this headline">¬∂</a></h3>
<p>We also configure the Image Server client, which allows this module to communicate with the image server. It does this much in the same way that a Publisher publishes messages‚Ä¶ when the module is ready for a new image it broadcasts that it is waiting for an image. The image server is a subscriber of these broadcasts, and once it hears this message it will provide an image to the model server.</p>
<p>The reason we have chosen this method rather than providing a service is that a service call blocks the kernel from processing more code until the call has completed and a response has been received, whereas a publisher will simply continue to broadcast a message, regardless if it is received or not. This ensures that processes are not tied up in a service call.</p>
<p>Once the Image Server hears that the client is in need of an image it begins the process and communicates to all nodes after it has updated the model server with the new image. It then changes these nodes ‚Äúwaiting‚Äù status to false via the ImageServerClient.callback. This ensures that while the module is engaging the model server the image server does not wastefully deliver images which no module will use, potentially reducing bandwidth by nearly 87% (assuming that an request is made twice a second, and the image server is reciving images at the rate of 16 FPS; since only two of those frames out of 16 can be used, only two will be delivered to the model server which would otherwise receive all 16!).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">image_server</span> <span class="k">import</span> <span class="n">ImageServerClient</span>
<span class="nb">print</span> <span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">ImageServerClient</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>class ImageServerClient(object):
    def __init__(self, name: str):
        self._name = name
        self.waiting = Bool()
        self.remote_status = Bool()
        self.setup_publisher()
        self.setup_subscriber()
        
    def setup_publisher(self):
        self.pub = rospy.Publisher(
            f&#39;image_request/{self._name}&#39;,
            Bool,
            queue_size=1
            )
        rospy.loginfo(
            f&#39;[{self._name}] Image server request services online.&#39;
            )
            
    def update(self, state: bool):
        self.waiting.data = state
        self.pub.publish(self.waiting)
   
    def status(self, entity = &quot;server&quot;):
        if entity == &quot;server&quot;:
            return self.remote_status.data
        else:
            return self.waiting.data
    
    def refresh(self, state: bool):
        self.waiting.data = state
        
    def setup_subscriber(self):
        rospy.Subscriber(
            &#39;image_server/status&#39;,
            Bool,
            self.callback,
            queue_size=1
            )
        rospy.loginfo(
            f&#39;[{self._name}] Subscribed to Image Server.&#39;
            )

    def callback(self, msg):
        self.remote_status = msg
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="action-loop">
<h3><span class="section-number">7.5.1.4. </span>Action Loop<a class="headerlink" href="#action-loop" title="Permalink to this headline">¬∂</a></h3>
<p>When the SceneSegmentationModule is ready to perform inference it contacts the model server and provides its modeling code ‚ÄúSEG‚Äù. The model server then computes the inference, and returns an inference message.</p>
<p>Inference Messages contain two variables:</p>
<ul class="simple">
<li><p>int32[]     structure</p></li>
<li><p>float32[]   inferences</p></li>
</ul>
<p>The Vision Processing Unit computes the segmentation of the image, and produces an array of variable length indicating the class of each pixel in the image. All ROS messages must be compatable between Python and C++, and Numpy ndarrays are not supported. In order to serialize these variable length inference results, I decided to flatten the numpy darrays into one dimensional vectors.</p>
<p>The structure variable is a list of 32 bit unsigned integers which indicate the original shape of the arrays produced by the Vision Processing Unit.The inference variable is a list of 32 bit floats.</p>
<p>The node can reshape the inference vector into the original arrays by using the structure vector as the original shape parameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Dissect</span><span class="p">(</span><span class="s2">&quot;action_loop&quot;</span><span class="p">,</span> <span class="n">SceneSegmentationModule</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>class SceneSegmentationModule(object):

    def action_loop(self):
        self.timer.lap(&quot;Wait for Service&quot;)
        rospy.wait_for_service(
            &#39;model_server/modeling_service&#39;
            )
        self.timer.time(&quot;Wait for Service&quot;)
        try:
            self.timer.lap(&quot;Modeling Server&quot;)
            rospy.logdebug(f&quot;[{self.name.abv}] Service Requested.&quot;)
            req = String()
            req.data = &quot;SEG&quot; #self.name.abv
            response = self.model_request(req)
            self.timer.time(&quot;Modeling Server&quot;, name = &quot;MOD&quot;)
            self.inference = response.results
            rospy.logdebug(
                f&quot;[{self.name.abv}] Mask shape received: {self.inference.structure}&quot;
                )
            return self.inference

        except rospy.ServiceException as e:
            rospy.logerr(f&quot;[{self.name.abv}] Service call failed: {e}&quot;)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="the-main-loop">
<h3><span class="section-number">7.5.1.5. </span>The Main Loop<a class="headerlink" href="#the-main-loop" title="Permalink to this headline">¬∂</a></h3>
<p>The complete process is as follows:</p>
<ol class="simple">
<li><p>the Node checks for any updates to its parameters and begins logging its time.</p></li>
<li><p>It then checks to see if there are any new images waiting for it at the model server.</p></li>
<li><p>If there are new images, it makes a model request.Prior to making the request however it takes down its own ‚Äúwaiting for image‚Äù since it cannot simultaniously make a request and use these images.</p></li>
<li><p>Following sucessfully receiving images it broadcasts the results to its subscribers. It does not update its request durring this time since while it is performing this action it cannot use any new images.</p></li>
<li><p>After publishing its inference results it updates its flag to reflect that it is ready for a new image which will be delivered by the time the loop repetes itself and it requests a new inference from the model server.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Dissect</span><span class="p">(</span><span class="s2">&quot;loop&quot;</span><span class="p">,</span> <span class="n">SceneSegmentationModule</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>class SceneSegmentationModule(object):

    def loop(self):
        rate = rospy.Rate(self.parameters.rate)
        while not rospy.is_shutdown():
            if self.parameters.updates == True:
                self.parameters.update()
                
            # Setup timer. Note that this resets on every iteration. 
            # Future development we may want to move this so that we can 
            # compute averages.
            
            self.timer = ProcessTimer(abv = self.name.abv)
            
            # Check to see if the server has released a new image and 
            # if so, start new modeling request
            
            status = self.image_server.status(&quot;server&quot;)
            rospy.logdebug(
                f&quot;[{self.name.abv}] Remote Image Server Status is: {status}&quot;
                )
            if status == True: 
                # Takes down image request flag while performing 
                # inference since inference time is not negligable
                
                self.image_server.update(False)
                
                my_status = self.image_server.status(&quot;me&quot;)
                rospy.logdebug(
                    f&quot;[{self.name.abv}] Waiting Status: {my_status}&quot;
                    )
                # Create the image mask
                try:
                    mask = self.action_loop()
                    self.pub.publish(mask)
                    rospy.logdebug(f&quot;[{self.name.abv}] Mask Published&quot;)
                except:
                    pass
            # Update the image server to let it know we need a new image
            
            self.image_server.update(True)
            rospy.logdebug(
                &quot;[SEG] Waiting Status: %s&quot;, 
                self.image_server.status(&quot;me&quot;)
                )
            self.timer.time(&quot;total_runtime&quot;)
            rate.sleep()
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./src/scene_segmentation_module"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="readme.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title"><span class="section-number">7. </span>Scene Segmentation Module</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="scene_segmentation_model.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">7.6. </span>Scene Segmentation Model</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Andrew Damico<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>